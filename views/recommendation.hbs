<div class="container">
    <div class="pt-2 pb-3 d-flex bd-highlight">
        <div id="track" class="p-2 flex-grow-1 bd-highlight">
            <div>
                <div class="card">
                    <div class="card-body">
                        <div class="text-center">
                            <img id="img" src="{{track.album.images.[0].url}}"
                                style="border-radius: 50%; height: 250px">
                            <footer class="pt-2">
                                <div id="player">
                                    {{!-- <audio controls class="embed-responsive-item">
                                        <source>
                                    </audio> --}}
                                </div>

                            </footer>
                        </div>
                        <ul class="pt-3 list-group list-group-flush">
                            <li class="list-group-item">
                                <a class="text-reset lead">Track name</a>
                                <footer><a id="trackName" class="text-muted"></a></footer>
                            </li>
                        </ul>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <a class="text-reset lead">Id</a>
                                <footer><a id="trackId" class="text-muted"></a></footer>
                            </li>
                        </ul>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <a class="text-reset lead">Artist Name</a>
                                <footer><a id="artistName" class="text-muted"></a></footer>
                            </li>
                        </ul>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <a class="text-reset lead">Release date</a>
                                <footer><a id="releaseDate" class="text-muted"></a></footer>
                            </li>
                        </ul>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <a class="text-reset lead">Track URI</a>
                                <footer><a class="text-success" id="trackUrl"></a>
                                </footer>
                            </li>
                        </ul>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <a class="text-reset lead">Artist URL</a>
                                <footer><a class="text-success" id="artistUrl"></a>
                                </footer>
                            </li>
                        </ul>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <a class="text-reset lead">Like this song?</a>
                                <footer class="pt-2">
                                    <div class="row">

                                        <div class="pl-3">
                                            <button onclick="vote(4)" class="btn btn-outline-success">
                                                <i class="far fa-laugh-beam fa-lg"></i> Yes
                                            </button>
                                        </div>
                                        <div class="pl-3">
                                            <button onclick="vote(3)" class="btn btn-outline-info">
                                                <i class="far fa-smile-wink fa-lg"></i> Maybe Yes
                                            </button>
                                        </div>
                                        <div class="pl-3">
                                            <button onclick="vote(2)" class="btn btn-outline-secondary">
                                                <i class="far fa-meh fa-lg"></i> Maybe No
                                            </button>
                                        </div>
                                        <div class="pl-3">

                                            <button onclick="vote(1)" class="btn btn-outline-danger">
                                                <i class="far fa-frown fa-lg"></i> No
                                            </button>
                                        </div>
                                    </div>

                                </footer>

                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>

        <div id="user" class="p-2 flex-grow-1 bd-highlight" style="display: none">

            <div class="px-5">
                <div class="text-center">
                    <h1 style="font-size: 38px" class="lead text-dark pb-3">Sample <span class="text-success">
                            Users</span>
                    </h1>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span id="userName1" class="lead">User #1 </span>
                        <div id="userAnswer1">

                        </div>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span id="userName2" class="lead">User #2 </span>
                        <div id="userAnswer2">

                        </div>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span id="userName3" class="lead">User #3 </span>
                        <div id="userAnswer3">

                        </div>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span id="userName4" class="lead">User #4 </span>
                        <div id="userAnswer4">

                        </div>
                    </li>

                    <li class="list-group-item">
                        <a class="lead">Do you like this song?</a>
                        <footer id="repeatAnswer" class="pt-2">
                            <div class="row">
                                <div class="pl-3">
                                    <button onclick="finalVote(4)" class="btn btn-outline-success">
                                        <i class="far fa-laugh-beam fa-lg"></i> Yes
                                    </button>
                                </div>
                                <div class="pl-3">
                                    <button onclick="finalVote(3)" class="btn btn-outline-info">
                                        <i class="far fa-smile-wink fa-lg"></i> Maybe Yes
                                    </button>
                                </div>
                                <div class="pl-3">
                                    <button onclick="finalVote(2)" class="btn btn-outline-secondary">
                                        <i class="far fa-meh fa-lg"></i> Maybe No
                                    </button>
                                </div>
                                <div class="pl-3">
                                    <button onclick="finalVote(1)" class="btn btn-outline-danger">
                                        <i class="far fa-frown fa-lg"></i> No
                                    </button>
                                </div>
                            </div>
                        </footer>
                        <div id="yourAnswer" style="display:none" class="pt-2">
                        </div>
                    </li>
                </ul>


            </div>
        </div>

        <div id="playlist" class="p-2 bd-highlight">
            <div class="card" style="width: 20rem;">
                <li class="list-group-item active text-center">Playlist</li>
                <ul class="list-group list-group-flush">
                    <li id="track1" class="list-group-item">1.</li>
                    <li id="track2" class="list-group-item">2.</li>
                    <li id="track3" class="list-group-item">3.</li>
                    <li id="track4" class="list-group-item">4.</li>
                    <li id="track5" class="list-group-item">5.</li>
                    <li id="track6" class="list-group-item">6.</li>
                    <li id="track7" class="list-group-item">7.</li>
                    <li id="track8" class="list-group-item">8.</li>
                    <li id="track9" class="list-group-item">9.</li>
                    <li id="track10" class="list-group-item">10.</li>

                </ul>
            </div>
            <div class="pt-3">
                <button id="nextStep" onclick="nextStep()" style="display:none"
                    class="btn-block btn-lg btn-outline-primary">Next
                    Step</button>
            </div>
        </div>


    </div>
    <div id="loading" class="text-center" style="padding-top: 20%; display: none">
        <div class="text-success">
            <div class="spinner-grow" style="width: 4rem; height: 4rem;" role="status">
            </div>
        </div>
        <div class="lead">Loading</div>
    </div>

</div>

<script>


    function showTrackById(trackId) {
        recommendationArray[arrayIndex].track_id = trackId
        recommendationArray[arrayIndex].user_id = user_id
        $.ajax({
            url: 'https://api.spotify.com/v1/tracks/' + trackId,
            headers: {
                'Authorization': 'Bearer ' + access_token
            },
            success: function (response) {
                $("#img").attr("src", response.album.images[0].url);
                // $("#player").html("src", response.preview_url)
                $("#player").html('')
                $("#player").html("<audio controls src=" + response.preview_url + " class='embed-responsive-item'>  <source> </audio>")
                $("#trackName").text(response.name)
                $("#trackId").text(response.id)
                $("#artistName").text(response.artists[0].name)
                $("#releaseDate").text(response.album.release_date)
                $("#trackUrl").text(response.external_urls.spotify)
                $("#trackUrl").attr("href", response.external_urls.spotify)
                $("#artistUrl").text(response.artists[0].external_urls.spotify)
                $("#trackUrl").attr("href", response.artists[0].external_urls.spotify)
                $("#track").show();
                $("#user").hide();
                $("#nextStep").hide();
                $("#yourAnswer").hide();
            }
        })
    }


    function shuffle(array) {
        for (var i = array.length; i > 1; i--) {
            var r = Math.floor(Math.random() * i);
            var temp = array[r];
            array[r] = array[i - 1];
            array[i - 1] = temp;
        }
    }

    let access_token = getCookie('access_token')
    let user_id = getCookie('user_id')
    let randomTracks25 = {{{ randomTracks25 }}}
    let randomTracks75 = {{{ randomTracks75 }}}

    let randomName = ['James', 'Kitsana', 'Wongsathorn', 'Bruce', 'Sathira', 'Wasuthun', 'Micky', 'Mond', 'Steve', 'Tom']
    let currentScore = 0

    // shuffle track arrays
    shuffle(randomTracks25)
    shuffle(randomTracks75)
    let recommendationArray = [] // data for sending to server by using jQuery POST
    let arrayIndex = 0 // index for pushing to recommendationArray
    recommendationArray[arrayIndex] = {}
    let playlistCount = 0
    let startRandomFrom = ""
    let yesAnswerCount = 0
    let noAnswerCount = 0
    // generate a random boolean, [0, 0.5) is starting from randomTracks25, [0.5, 1) is starting from randomTracks75.
    let random = Math.random();
    let randomTrackId = ""
    if (random >= 0.5) {
        console.log(75)
        startRandomFrom = '75'
        randomTrackId = randomTracks75.pop()
        recommendationArray[arrayIndex].list = 75
    }
    else {
        console.log(25)
        startRandomFrom = '25'
        randomTrackId = randomTracks25.pop()
        recommendationArray[arrayIndex].list = 25
    }
    // display initial track
    showTrackById(randomTrackId)

    function vote(score) {
        currentScore = score
        recommendationArray[arrayIndex].answer_a = currentScore
        showLoading()
        let min = 1,
            max = 2;
        let rand = Math.floor(Math.random() * (max - min + 1) + min); // generate Random number between 5 - 10
        recommendationArray[arrayIndex].waiting_a = rand
        setTimeout(showAnonymousUser, rand * 1000);
    }

    function finalVote(score) {
        currentScore = score
        recommendationArray[arrayIndex].answer_b = currentScore
        showLoading()
        let min = 1,
            max = 2;
        let rand = Math.floor(Math.random() * (max - min + 1) + min); // generate Random number between 5 - 10
        recommendationArray[arrayIndex].waiting_b = rand
        setTimeout(showResult, rand * 1000);
    }

    function showLoading() {
        $("#track").hide();
        $("#user").hide();
        $("#playlist").hide();
        $("#loading").show();
    }

    function showAnonymousUser() {
        // if user's answer is NO or MAYBE NO
        if (currentScore == 1 || currentScore == 2)
            for (let index = 0; index < 4; index++) {
                // hide name
                $("#userName" + (index + 1)).html('User #' + (index + 1))
                // set dummy answer
                let random = Math.random();
                if (random <= 0.1) {
                    $("#userAnswer" + (index + 1)).html(maybeNoButtonHTML())
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 2

                }
                else if (random <= 0.3) {
                    $("#userAnswer" + (index + 1)).html(noButtonHTML())
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 1
                }
                else if (random <= 0.6) {
                    $("#userAnswer" + (index + 1)).html(maybeYesButtonHTML())
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 3
                }
                else {
                    $("#userAnswer" + (index + 1)).html(yesButtonHTML())
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 4
                }
            }
        // if user's answer is YES or MAYBE YES
        else {
            for (let index = 0; index < 4; index++) {
                // hide name
                $("#userName" + (index + 1)).html('User #' + (index + 1))
                // set dummy answer
                let random = Math.random();
                if (random <= 0.1) {
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 3
                    $("#userAnswer" + (index + 1)).html(maybeYesButtonHTML())
                }
                else if (random <= 0.3) {
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 4
                    $("#userAnswer" + (index + 1)).html(yesButtonHTML())
                }
                else if (random <= 0.6) {
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 2
                    $("#userAnswer" + (index + 1)).html(maybeNoButtonHTML())
                }
                else {
                    recommendationArray[arrayIndex]["bot" + index + "_a"] = 1
                    $("#userAnswer" + (index + 1)).html(noButtonHTML())
                }
            }
        }
        $("#loading").hide();
        $("#playlist").show();
        $("#user").show();
        $("#repeatAnswer").show();
    }

    function showResult() {
        // add the track to playlist if user's answer is YES or MAYBE YES
        let shouldAdd = false
        if (currentScore == 3 || currentScore == 4) {
            let trackId = $("#trackId").text()
            let artistName = $("#artistName").text()
            let trackName = $("#trackName").text()
            console.log(trackId + " " + artistName + " " + trackName)
            shouldAdd = true
        }
        shuffle(randomName)
        for (let index = 0; index < 4; index++) {
            let random = Math.random();
            if (recommendationArray[arrayIndex]["bot" + index + "_a"] == 3 || recommendationArray[arrayIndex]["bot" + index + "_a"] == 4) {
                if (random >= 0.5) {
                    recommendationArray[arrayIndex]["bot" + index + "_b"] = 4
                    $("#userAnswer" + (index + 1)).html(yesButtonHTML())
                }
                else {
                    recommendationArray[arrayIndex]["bot" + index + "_b"] = 3
                    $("#userAnswer" + (index + 1)).html(maybeYesButtonHTML())
                }
            }
            else {
                shouldAdd = false
                if (random >= 0.5) {
                    recommendationArray[arrayIndex]["bot" + index + "_b"] = 1
                    $("#userAnswer" + (index + 1)).html(noButtonHTML())
                }
                else {
                    recommendationArray[arrayIndex]["bot" + index + "_b"] = 2
                    $("#userAnswer" + (index + 1)).html(maybeNoButtonHTML())
                }
            }
            // set name of dummy user
            $("#userName" + (index + 1)).html((index + 1) + '. ' + randomName[index])
        }
        if (shouldAdd) {
            addPlaylist(trackId, trackName, artistName)
        }
        $("#loading").hide();
        $("#playlist").show();
        $("#user").show();
        $("#repeatAnswer").hide();

        if (currentScore == 3) {
            yesAnswerCount++
            $("#yourAnswer").html(maybeYesButtonHTML());
        }
        else if (currentScore == 4) {
            yesAnswerCount++
            $("#yourAnswer").html(yesButtonHTML());
        }
        else if (currentScore == 2) {
            noAnswerCount++
            $("#yourAnswer").html(maybeNoButtonHTML());
        }
        else {
            noAnswerCount++
            $("#yourAnswer").html(noButtonHTML());
        }
        $("#yourAnswer").show();

        if (playlistCount == 10) {
            $("#nextStep").html('Finish');
        }
        $("#nextStep").show();
        arrayIndex++
    }

    function nextStep() {
        if (playlistCount == 10) {
            // send data to server
            $.ajax({
                type: 'POST',
                data: JSON.stringify(recommendationArray),
                contentType: 'application/json',
                url: '/recommendation'
            });
        }
        else if (startRandomFrom == '25') {
            recommendationArray[arrayIndex] = {}
            if (noAnswerCount >= 5) {
                recommendationArray[arrayIndex].list = 75
                noAnswerCount = 0
                yesAnswerCount = 0
                startRandomFrom = '75'
                showTrackById(randomTracks75.pop())
            }
            else {
                recommendationArray[arrayIndex].list = 25
                showTrackById(randomTracks25.pop())
            }
        }
        else {
            recommendationArray[arrayIndex] = {}
            if (yesAnswerCount >= 5) {
                recommendationArray[arrayIndex].list = 25
                noAnswerCount = 0
                yesAnswerCount = 0
                startRandomFrom = '25'
                showTrackById(randomTracks25.pop())
            }
            else {
                recommendationArray[arrayIndex].list = 75
                showTrackById(randomTracks75.pop())
            }
        }
    }

    function addPlaylist(trackId, trackName, artistName) {
        $("#track" + (playlistCount + 1)).html(`<span>${playlistCount + 1}. </span><a class="text-success" href="/song/${trackId}">${trackName}</a><footer class="blockquote-footer"> ${artistName}</footer>`)
        playlistCount++
    }

    function noButtonHTML() {
        return `<button class="btn btn-outline-danger"><i class="far fa-frown fa-lg"></i> No </button>`
    }

    function maybeNoButtonHTML() {
        return `<button class="btn btn-outline-secondary"><i class="far fa-meh fa-lg"></i> Maybe No </button>`
    }
    function yesButtonHTML() {
        return `<button class="btn btn-outline-success"><i class="far fa-laugh-beam fa-lg"></i> Yes </button>`
    }
    function maybeYesButtonHTML() {
        return `<button class="btn btn-outline-info"><i class="far fa-smile-wink fa-lg"></i> Maybe Yes </button>`
    }
</script>

<style>
    .list-group-item.active {
        background-color: #1DB954;
        border-color: #1DB954;
        color: white;
        font-weight: bold
    }
</style>